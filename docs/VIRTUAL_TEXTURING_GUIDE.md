# Virtual Texturing - Step-by-Step Guide

This guide explains how to enable and use the virtual texturing system.

## Overview

The virtual texturing (VT) system uses **pre-baked megatexture tiles** that are streamed on-demand at runtime. The workflow has two phases:

1. **Build-time**: Generate tiles from heightmap, biome data, roads, and materials
2. **Runtime**: Stream tiles based on camera visibility

## Prerequisites

Before generating virtual texture tiles, you need:

| Input | Description | Generated By |
|-------|-------------|--------------|
| Heightmap PNG | 16-bit terrain heightmap | `terrain_preprocess` or external source |
| Biome Map PNG | Zone classification (encoded as colors) | `biome_preprocess` |
| Roads GeoJSON | Road network connecting settlements | `road_generator` |
| Material Textures | Albedo/normal maps for each biome | Already in `assets/materials/` |

## Step 1: Build the Tools

Build all preprocessing tools:

```bash
cmake --preset debug && cmake --build build/debug
```

This builds:
- `build/debug/biome_preprocess` - Generates biome zone map
- `build/debug/road_generator` - Generates road network
- `build/debug/tile_generator` - Generates VT tiles

## Step 2: Generate Preprocessing Data

### 2.1 Generate Biome Map

```bash
./build/debug/biome_preprocess \
    --heightmap <path-to-heightmap.png> \
    --erosion-dir <path-to-erosion-data> \
    --output assets/generated
```

This produces:
- `assets/generated/biome_zones.png` - Biome classification map
- `assets/generated/biome.meta` - Metadata file

### 2.2 Generate Roads (Optional)

```bash
./build/debug/road_generator \
    --heightmap <path-to-heightmap.png> \
    --settlements assets/generated/settlements.json \
    --output assets/generated/roads.geojson
```

## Step 3: Generate Virtual Texture Tiles

### Basic Usage

Generate all mip levels:

```bash
./build/debug/tile_generator \
    --heightmap <path-to-heightmap.png> \
    --biomemap assets/generated/biome_zones.png \
    --output assets/virtual_textures/terrain \
    --materials assets/materials/terrain
```

### Options

| Option | Default | Description |
|--------|---------|-------------|
| `--heightmap <path>` | (required) | 16-bit heightmap PNG |
| `--biomemap <path>` | (required) | Biome zone map PNG |
| `--output <dir>` | (required) | Output directory for tiles |
| `--materials <path>` | `assets/textures/terrain` | Base path for material textures |
| `--roads <path>` | (optional) | Roads GeoJSON file |
| `--terrain-size <f>` | `16384` | Terrain size in meters |
| `--tile-res <n>` | `128` | Tile resolution in pixels |
| `--tiles-per-axis <n>` | `512` | Number of tiles per axis at mip 0 |
| `--max-mip <n>` | `9` | Maximum mip level |
| `--single-mip <n>` | - | Generate only one mip level |
| `--single-tile <x,y,mip>` | - | Generate a single tile (for testing) |
| `--compress` / `--dds` | off | Output BC1 compressed DDS files |

### Testing a Single Tile

To quickly test the pipeline, generate just one tile:

```bash
./build/debug/tile_generator \
    --heightmap <path-to-heightmap.png> \
    --biomemap assets/generated/biome_zones.png \
    --output assets/virtual_textures/test \
    --single-tile 256,256,0
```

### Generate One Mip Level

For faster iteration, generate just the coarsest mip level first:

```bash
./build/debug/tile_generator \
    --heightmap <path-to-heightmap.png> \
    --biomemap assets/generated/biome_zones.png \
    --output assets/virtual_textures/terrain \
    --single-mip 8
```

## Step 4: Output Structure

After generation, tiles are organized by mip level:

```
assets/virtual_textures/terrain/
├── mip0/
│   ├── tile_0_0.png      (or .dds if --compress)
│   ├── tile_0_1.png
│   └── ...
├── mip1/
│   └── ...
├── mip2/
│   └── ...
└── ... up to mip8/
```

Tile counts per mip level (with default 512 tiles/axis):

| Mip | Tiles/Axis | Total Tiles |
|-----|------------|-------------|
| 0 | 512 | 262,144 |
| 1 | 256 | 65,536 |
| 2 | 128 | 16,384 |
| 3 | 64 | 4,096 |
| 4 | 32 | 1,024 |
| 5 | 16 | 256 |
| 6 | 8 | 64 |
| 7 | 4 | 16 |
| 8 | 2 | 4 |
| 9 | 1 | 1 |

## Step 5: Run the Application

Once tiles are generated, run the application:

```bash
./run-debug.sh
```

The VirtualTextureSystem will automatically:
1. Load the coarsest mip levels on startup
2. Stream finer tiles as the camera moves
3. Use LRU eviction when the cache fills

## Troubleshooting

### Missing Tiles at Runtime

If tiles appear blurry or missing:
- Ensure all mip levels are generated (especially coarse ones)
- Check console for tile loading errors
- Verify tile paths match expected structure

### Slow Tile Generation

- Use `--single-mip` to generate mip levels incrementally
- Use `--compress` for smaller output files (4x reduction)
- Coarse mips (6-9) generate quickly; fine mips (0-2) take longer

### Memory Issues

Default cache is 4096x4096 pixels (64MB for RGBA8). Adjust in code:

```cpp
// In VirtualTextureConfig
config.cacheSizePixels = 2048;  // Smaller cache: 16MB
```

## Debug Visualization

Enable VT debug mode in shaders to visualize:
- Tile boundaries (white grid lines)
- Mip levels (color-coded by LOD)
- Cache pressure (tiles falling back to coarser mips)

## Quick Start Summary

```bash
# 1. Build tools
cmake --preset debug && cmake --build build/debug

# 2. Generate biome data (if not already done)
./build/debug/biome_preprocess --heightmap terrain.png --output assets/generated

# 3. Generate VT tiles (start with coarse mips for testing)
./build/debug/tile_generator \
    --heightmap terrain.png \
    --biomemap assets/generated/biome_zones.png \
    --output assets/virtual_textures/terrain \
    --single-mip 6

# 4. Run application
./run-debug.sh
```
